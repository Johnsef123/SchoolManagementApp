@page "/Products/Create"
@page "/Products/Update/{id:int}"

@inject IProductRepository _productRepository
@inject ICategoryRepository _categoryRepository
@inject NavigationManager _navigationManager
@inject IWebHostEnvironment _webHostEnvironment
@inject IJSRuntime _jsRuntime



@if (IsProcessing)
{
	<div class="position-absolute w-75 h-75 d-flex flex-column align-items-center bg-white justify-content-center">
		<img src="/Images/loading.gif" alt="loading" />
	</div>
}
else
{
	<div class="card shadow border-0 m-4">
		<div class="card-header bg-black bg-gradient py-3">
			<div class="row">
				<div class="col-12 text-center">
					<h2 class="text-white py-2">
						@(Id > 0 ? "Update Product" : "Create New Product")
					</h2>
				</div>
			</div>
		</div>
		<div class="card-body p-4">
			<EditForm Model="Product" FormName="ProductInsertUpdate" OnValidSubmit="InsertUpdateProduct">
				<DataAnnotationsValidator/>

				<div class="border-3 p-3 mt-4 ">
					<div class="form-floating my-3 col-12">
						<InputText class="form-control" id="Name" @bind-Value="Product.Name" placeholder="Product Name"/>
						<label for="Name">Product Name</label>
						<ValidationMessage For="@(() => Product.Name)" />
					</div>

					

					<div class="form-floating my-3 col-12">
						@if (Product.ImageUrl == null)
						{
							<InputFile OnChange="LoadFiles" class="form-control" id="customFile" accept="image/x-png,image/jpeg"></InputFile>

							<label for="customFile">Upload Image</label>
						}
						
						
						@if(Product.ImageUrl != null)
						{
							
							<div class="row">
								<div class="col-3">
									<img src="@Product.ImageUrl" alt="..." class="img-thumbnail"/>
								</div>
								<div class="col-md-9">
									<i class="bi bi-trash btn btn-outline-danger" @onclick="DeleteImage">Remove</i>
								</div>
							</div>
						}

					</div>

					<div class="form-floating my-3 col-12">
						<InputSelect class="form-select id="Category" @bind-Value="Product.CategoryId">
							<option value="0" disabled selected>-Select Category-</option>
							@foreach (var category in _categories)
							{
								<option value="@category.Id">@category.Name</option>
							}
						</InputSelect>
						<label for="Category">Product Category</label>
					</div>

					<div class="form-floating my-3 col-12">
						<InputNumber class="form-control" id="Price" @bind-Value="Product.Price" placeholder="Product Price" />
						<label for="Price">Product Price</label>
						<ValidationMessage For="@(() => Product.Price)" />
					</div>

					<div class="form-floating my-3 col-12">
						<InputNumber class="form-control" id="Stock" @bind-Value="Product.Stock" placeholder="Product Stock" />
						<label for="Stock">Product Stock</label>
						<ValidationMessage For="@(() => Product.Stock)" />
					</div>

					<div class="form-floating my-3 col-12">
						<InputText class="form-control" id="Description" @bind-Value="Product.Description" placeholder="Product Description" />
						<label for="Description">Product Description</label>
					</div>
				
					<div class="row mt-3">
						<div class=" col-6 col-md-3">
							<button type="submit" class="btn btn-primary form-control" disabled="@IsProcessing">
								<i class="bi bi-floppy-fill"></i> @(Product.Id==0? " Create New Product" : "Update Product")
							</button>
						</div>
						<div class=" col-6 col-md-3">
							<a href="Products" class="btn btn-outline-primary form-control" disabled="@IsProcessing">
								<i class="bi bi-box-arrow-left"></i> Back To List
							</a>
						</div>
					</div>

				</div>
			</EditForm>
		</div>
	</div>
}




@code {
	private bool IsProcessing { get; set; } = true;
	private string? _directoryPath { get; set; }

	protected override Task OnInitializedAsync()
	{
		_directoryPath = Path.Combine(_webHostEnvironment.WebRootPath, "Images", "ProductImages");

		return base.OnInitializedAsync();
	}

	private IEnumerable<Category> _categories = new List<Category>();

	[Parameter]
	public int Id { get; set; }

	[SupplyParameterFromForm]
	private Product Product { get; set; } = new Product();

	protected override async Task OnAfterRenderAsync(bool firstRender)
	{
		if (firstRender)
		{
			await LoadProductAndCategoryList();
			IsProcessing = false;
			StateHasChanged();
		}
	}

	private async Task LoadProductAndCategoryList()
	{
		if (Id > 0)
		{
			Product = await _productRepository.GetAsync(Id);
		}
		_categories = await _categoryRepository.GetAllAsync();
	}

	private async Task InsertUpdateProduct()
	{
		IsProcessing = true;
		if (Product.Id == 0)
		{
			//create
			await _productRepository.CreateAsync(Product);
			await _jsRuntime.ToastrSuccess("Product Created Successfully");
		}
		else
		{
			//update
			await _productRepository.UpdateAsync(Product);
			await _jsRuntime.ToastrSuccess("Product Updated Successfully");
		}
		IsProcessing = false;
		_navigationManager.NavigateTo("Products");
	}

	private async Task LoadFiles(InputFileChangeEventArgs e)
	{
		IsProcessing = true;
		var file = e.File;
		FileInfo fileInfo = new(file.Name);
		var newFileName = $"{Guid.NewGuid()}.{fileInfo.Extension}";
		if(!Directory.Exists(_directoryPath))
		{
			Directory.CreateDirectory(_directoryPath);
		}
		var path = Path.Combine(_directoryPath, newFileName);

		await using FileStream fileStream = new(path, FileMode.Create);
		await file.OpenReadStream(file.Size).CopyToAsync(fileStream);
		Product.ImageUrl = $"/Images/ProductImages/{newFileName}";

		IsProcessing = false;
	}

	private void DeleteImage()
	{
		if(Product.ImageUrl == null)
		{
			return;
		}

		var fileToDelete = Product.ImageUrl.Split('/').Reverse().First();

		var filePathToDeleteImage = Path.Combine(_directoryPath, fileToDelete);
		if (!File.Exists(filePathToDeleteImage))
		{
			Product.ImageUrl = null;
			return;
		}
		File.Delete(filePathToDeleteImage);
		Product.ImageUrl = null;
		return;
	}


}
