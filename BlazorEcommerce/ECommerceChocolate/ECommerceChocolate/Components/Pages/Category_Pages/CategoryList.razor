@page "/Categories"

@inject ICategoryRepository _CategoryRepository
@inject IJSRuntime _js

<title>Categories</title>


@if (IsProcessing)
{
	<div class="position-absolute w-75 h-75 d-flex flex-column align-items-center bg-white justify-content-center">
		<img src="/Images/loading.gif" alt="loading"/>
	</div>
}
else
{
	<BsModal OnModalConfirmation="ConfirmDeleteClicked"
		ButtonBootstrapStyle="btn-danger"
	ButtonText="Delete"
	Title="Are you sure you want to delete this category?"></BsModal>
	<div class="card shadow border-0 m-4">
		<div class="card-header bg-black bg-gradient py-3">
			<div class="row">
				<div class="col-12 text-center">
					<h2 class="text-white py-2">
						Category List
					</h2>
				</div>
			</div>
		</div>
		<div class="card-body p-4">
			<div class="row pb-3">
				<div class="col-12 text-end">

					<a class="btn btn-lg btn-secondary" href="/Categories/Create" style=" background-color:green; border:none; width:250px;"> <i class="bi bi-plus-square-fill"></i>  Add New Category</a>
				</div>
			</div>
			@if (Categories.Any())
			{
				<table class="table table-bordered table-striped">
					<thead>
						<tr>
							<th>Name</th>
							<th></th>
						</tr>
					</thead>
					<tbody>
						@foreach(var item in Categories)
						{
							<tr>
								<td>@item.Name</td>
								<td>
									<a href="@($"/Categories/Update/{item.Id}")" class="btn btn-primary"><i class="bi bi-pencil-square"></i>  Edit</a>
									<button class="btn btn-danger" @onclick="()=>HandleDelete(item.Id)"><i class="bi bi-trash3"></i> Delete</button>
								</td>
							</tr>
						}
					</tbody>
				</table>
			}

		</div>

	</div>
}




@code {
	private bool IsProcessing { get; set; } = true;
	private IEnumerable<Category> Categories { get; set; } = new List<Category>();
	private int DeleteCategoryID { get; set; } = 0;

	protected override async Task OnAfterRenderAsync(bool firstRender)
	{
		if (firstRender)
		{
			await LoadCategories();
			IsProcessing = false;
			StateHasChanged();
		}
	}

	private async Task LoadCategories()
	{
		//Load Categories from Repository
		Categories = await _CategoryRepository.GetAllAsync();
	}

	private void HandleDelete(int id)
	{
		DeleteCategoryID = id;
		_js.InvokeVoidAsync("ShowConfirmationModal");
	}

	private async Task ConfirmDeleteClicked(bool isConfirmed)
	{
		IsProcessing = true;
		await _js.InvokeVoidAsync("HideConfirmationModal");
		if(isConfirmed && DeleteCategoryID != 0)
		{
			var result = await _CategoryRepository.DeleteAsync(DeleteCategoryID);
			if (result)
			{
				_js?.ToastrSuccess("Category Deleted Successfully");
			}
			else
			{
				_js?.ToastrError("Error While Deleting Category");
			}
			await LoadCategories();
		}
		else 
		{
			DeleteCategoryID = 0;
		}
		IsProcessing = false;
	}

	
}
